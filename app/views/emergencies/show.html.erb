<h1>Emergency &raquo;<%=h @emergency.title %>&laquo;</h1>
Declared on <%=h @emergency.created_at %> by <%= buildUserLink @emergency.user.id %> 
<% unless @emergency.updated_at == @emergency.created_at %>
  [Last update: <%=h @emergency.updated_at %>]
<% end %>

<div id="emergency-description" class="emergency-section">
  <h2>Description</h2>
  <%= simple_format h(@emergency.description) %>
</div>

<script type="text/javascript">
  <%= remote_function :url => { :action => "get_chat_messages", :id => @emergency.id }, :update => "emergency-chat-list", :complete => "scrollToBottom('emergency-chat-list')" %>
</script>

<div id="emergency-chat" class="emergency-section">
  <h2 id="emergency-chat-title">Chat</h2>
  <div id="emergency-chat-top">
    <input id="autoscroll" type="checkbox" checked="checked" /> Auto scroll
    |
    <%= link_to "More", "#", :id => "emergency-chat-grower", :onclick => "scaleChatField()" %>
  </div>
  <ul id="emergency-chat-list">
  </ul>
  <div id="emergency-chat-new-message">
    <% form_remote_tag :url => "/emergencies/post_chat_message", :complete => "document.getElementById('emergency-chat-message-field').value='';" do %>
      <%= hidden_field_tag "[chat_message]emergency_id", @emergency.id %>
      <%= text_field_tag "[chat_message]message", "Type your message here", :maxlength => 250, :id => "emergency-chat-message-field", :onclick => "clearFieldWithText(this, 'Type your message here')" %>
      <%= submit_tag "Send", :id => "emergency-chat-submit-field" %>
    <% end %>
  </div>
</div>

<%= periodically_call_remote :url => { :action => "get_chat_messages", :id => @emergency.id }, :frequency => 1, :update => "emergency-chat-list", :complete => "scrollToBottom('emergency-chat-list')" %>

<div id="emergency-comments" class="emergency-section">
  <div class="comments">
    <h2>Comments</h2><br />
    <%= render :partial => "comment", :locals => { :emergency => @emergency } %>
  </div>

  <div class="new-comment">
    <h2>New comment</h2>
    <% form_for :new_comment, :url => { :action => "store_comment" } do |f| %>
      <div class="new-comment-form">
        <%= f.hidden_field :emergency_id, :value => @emergency.id %>
        <%= f.label :title, "Title", :float => "left" %>
        <%= f.text_field :title %>
        <%= f.label :comment, "Comment", :float => "left" %>
        <%= f.text_area :comment, :cols => "80", :rows => "5" %>
      </div>
      <div class="new-comment-description">
        <strong>Use this form to leave a comment on this emergency.</strong>
        You can delete your own comments at any time. Note that your name
        will be visible above the comment.

        <br /><br />

        No HTML allowed. Lines break automatically.
      </div>
      <p><%= submit_tag "Add comment", :disable_with => "Please wait" %></p>
    <% end %>
  </div>
</div>

<div id="emergency-close">
  <% form_tag "/emergencies/close/#{@emergency.id}" do %>
    <%= submit_tag "Close this emergency" %>
  <% end %>
</div>
